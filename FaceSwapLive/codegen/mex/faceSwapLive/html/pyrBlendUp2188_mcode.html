<pre class="code">
<span class="srcline"><span class="lineno"><a href="230,57" id="srcline57"> 57</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="230,58" id="srcline58"> 58</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S42T802U542">imageRecon</span>] = pyrBlendUp(<span class="var type1" id="S43T802U545">image</span>, <span class="var type1" id="S44T173U546">imageSz1</span>, <span class="var type1" id="S45T173U547">imageSz2</span>, <span class="var type1" id="S46T802U548">laplacian</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="230,59" id="srcline59"> 59</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="230,60" id="srcline60"> 60</a></span><span class="line">    <span class="mxinfo " id="T515:U6"><span class="var type1" id="S47T515U551">k</span> = <span class="mxinfo " id="T515:U8">[1 4 6 4 1]/16</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="230,61" id="srcline61"> 61</a></span><span class="line">    <span class="mxinfo " id="T807:U9"><span class="var type1" id="S48T807U563">kernel</span> = <span class="mxinfo " id="T807:U11">conv2(<span class="var type1" id="S47T515U566">k</span>, <span class="var type1" id="S47T515U568">k</span>')</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="230,62" id="srcline62"> 62</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="230,63" id="srcline63"> 63</a></span><span class="line">    <span class="mxinfo " id="T802:U14"><span class="var type1" id="S42T802U571">imageRecon</span> = <span class="mxinfo " id="T802:U16">zeros(<span class="mxinfo " id="T4:U17">size(<span class="var type1" id="S43T802U576">image</span>,1)</span>, <span class="mxinfo " id="T4:U19">size(<span class="var type1" id="S43T802U580">image</span>,2)</span>, <span class="mxinfo " id="T4:U21">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="230,64" id="srcline64"> 64</a></span><span class="line">    <span class="mxinfo " id="T961:U22"><span class="mxinfo " id="T961:U23"><span class="var type1" id="S42T802U586">imageRecon</span>(<span class="mxinfo " id="T1:U25"><span class="mxinfo " id="T4:U26">1</span>:<span class="mxinfo " id="T4:U27">2</span>:<span class="mxinfo " id="T4:U28"><span class="var type1" id="S45T173U592">imageSz2</span>(<span class="mxinfo " id="T4:U30">1</span>)</span></span>, <span class="mxinfo " id="T1:U31"><span class="mxinfo " id="T4:U32">1</span>:<span class="mxinfo " id="T4:U33">2</span>:<span class="mxinfo " id="T4:U34"><span class="var type1" id="S45T173U599">imageSz2</span>(<span class="mxinfo " id="T4:U36">2</span>)</span></span>,:)</span> = <span class="mxinfo " id="T961:U37"><span class="var type1" id="S43T802U603">image</span>(<span class="mxinfo " id="T1:U39"><span class="mxinfo " id="T4:U40">1</span>:<span class="mxinfo " id="T4:U41"><span class="var type1" id="S44T173U607">imageSz1</span>(<span class="mxinfo " id="T4:U43">1</span>)</span></span>, <span class="mxinfo " id="T1:U44"><span class="mxinfo " id="T4:U45">1</span>:<span class="mxinfo " id="T4:U46"><span class="var type1" id="S44T173U612">imageSz1</span>(<span class="mxinfo " id="T4:U48">2</span>)</span></span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="230,65" id="srcline65"> 65</a></span><span class="line">    <span class="mxinfo " id="T961:U49"><span class="mxinfo " id="T961:U50"><span class="var type1" id="S42T802U618">imageRecon</span>(<span class="mxinfo " id="T1:U52"><span class="mxinfo " id="T4:U53">1</span>:<span class="mxinfo " id="T4:U54"><span class="var type1" id="S45T173U622">imageSz2</span>(<span class="mxinfo " id="T4:U56">1</span>)</span></span>, <span class="mxinfo " id="T1:U57"><span class="mxinfo " id="T4:U58">1</span>:<span class="mxinfo " id="T4:U59"><span class="var type1" id="S45T173U627">imageSz2</span>(<span class="mxinfo " id="T4:U61">2</span>)</span></span>,:)</span> = <span class="mxinfo " id="T961:U62"><span class="mxinfo " id="T961:U63">imfilter(<span class="mxinfo " id="T961:U64"><span class="var type1" id="S42T802U634">imageRecon</span>(<span class="mxinfo " id="T1:U66"><span class="mxinfo " id="T4:U67">1</span>:<span class="mxinfo " id="T4:U68"><span class="var type1" id="S45T173U638">imageSz2</span>(<span class="mxinfo " id="T4:U70">1</span>)</span></span>, <span class="mxinfo " id="T1:U71"><span class="mxinfo " id="T4:U72">1</span>:<span class="mxinfo " id="T4:U73"><span class="var type1" id="S45T173U643">imageSz2</span>(<span class="mxinfo " id="T4:U75">2</span>)</span></span>,:)</span>, 4*<span class="var type1" id="S48T807U648">kernel</span>, <span class="string">'circular'</span>, <span class="string">'conv'</span>)</span> + <span class="mxinfo " id="T961:U77"><span class="var type1" id="S46T802U652">laplacian</span>(<span class="mxinfo " id="T1:U79"><span class="mxinfo " id="T4:U80">1</span>:<span class="mxinfo " id="T4:U81"><span class="var type1" id="S45T173U656">imageSz2</span>(<span class="mxinfo " id="T4:U83">1</span>)</span></span>, <span class="mxinfo " id="T1:U84"><span class="mxinfo " id="T4:U85">1</span>:<span class="mxinfo " id="T4:U86"><span class="var type1" id="S45T173U661">imageSz2</span>(<span class="mxinfo " id="T4:U88">2</span>)</span></span>,:)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="230,66" id="srcline66"> 66</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="230,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% function blurred = blur(im1, im2, mask, levelsLeft)</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,69" id="srcline69"> 69</a></span><span class="line"><span class="comment">%         %% if levelsLeft == 1, go down another step</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,70" id="srcline70"> 70</a></span><span class="line"><span class="comment">%     if levelsLeft == 1 || numel(im1) &lt; 27</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,71" id="srcline71"> 71</a></span><span class="line"><span class="comment">%         blurred = bsxfun(@times, im1,mask) + bsxfun(@times, im2, ~mask);</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,72" id="srcline72"> 72</a></span><span class="line"><span class="comment">%     else</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,73" id="srcline73"> 73</a></span><span class="line"><span class="comment">%         %% blur with gaussian, subsample</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,74" id="srcline74"> 74</a></span><span class="line"><span class="comment">%         k = [1 4 6 4 1]/16;</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">%         kernel = conv2(k, k');</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">% %         kernel = fspecial('gaussian',5,1.5);</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">%         blurmask = imfilter(mask, kernel, 'circular');</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,78" id="srcline78"> 78</a></span><span class="line"><span class="comment">%         blurmask = blurmask(1:2:end, 1:2:end);</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,79" id="srcline79"> 79</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="230,80" id="srcline80"> 80</a></span><span class="line"><span class="comment">%         gaussLarge = imfilter(im1, kernel, 'circular');</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,81" id="srcline81"> 81</a></span><span class="line"><span class="comment">%         gaussian1 = gaussLarge(1:2:end, 1:2:end,:);</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,82" id="srcline82"> 82</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="230,83" id="srcline83"> 83</a></span><span class="line"><span class="comment">%         gaussLarge = imfilter(im2, kernel, 'circular');</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,84" id="srcline84"> 84</a></span><span class="line"><span class="comment">%         gaussian2 = gaussLarge(1:2:end, 1:2:end,:);</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,85" id="srcline85"> 85</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="230,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">%         %% subtract to get laplace</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,87" id="srcline87"> 87</a></span><span class="line"><span class="comment">%         gaussRecon = zeros(size(im1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,88" id="srcline88"> 88</a></span><span class="line"><span class="comment">%         gaussRecon(1:2:end, 1:2:end,:) = gaussian1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,89" id="srcline89"> 89</a></span><span class="line"><span class="comment">%         laplacian1 = im1 - imfilter(gaussRecon, 4*kernel, 'circular');</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,90" id="srcline90"> 90</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="230,91" id="srcline91"> 91</a></span><span class="line"><span class="comment">%         gaussRecon(1:2:end, 1:2:end,:) = gaussian2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,92" id="srcline92"> 92</a></span><span class="line"><span class="comment">%         laplacian2 = im2 - imfilter(gaussRecon, 4*kernel, 'circular');</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,93" id="srcline93"> 93</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="230,94" id="srcline94"> 94</a></span><span class="line"><span class="comment">%         maskRecon = zeros(size(mask));</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,95" id="srcline95"> 95</a></span><span class="line"><span class="comment">%         maskRecon(1:2:end, 1:2:end,:) = double(blurmask);</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,96" id="srcline96"> 96</a></span><span class="line"><span class="comment">%         maskRecon = imfilter(maskRecon, 4*kernel, 'circular');</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,97" id="srcline97"> 97</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="230,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">%         blurredTemp = blur(gaussian1, gaussian2, blurmask, levelsLeft-1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,99" id="srcline99"> 99</a></span><span class="line"><span class="comment">%         blurred = zeros(size(im1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,100" id="srcline100">100</a></span><span class="line"><span class="comment">%         blurred(1:2:end, 1:2:end,:) = blurredTemp;</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,101" id="srcline101">101</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="230,102" id="srcline102">102</a></span><span class="line"><span class="comment">%         blurred = imfilter(blurred, 4*kernel, 'circular') + bsxfun(@times, laplacian1,maskRecon)  + bsxfun(@times, laplacian2,(1-maskRecon));</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,103" id="srcline103">103</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="230,104" id="srcline104">104</a></span><span class="line"><span class="comment">% end</span></span></span>
</pre>
